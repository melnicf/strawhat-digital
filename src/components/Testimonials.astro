---
import { getCollection } from "astro:content";
import { getImage } from "astro:assets";
import TestimonialCarousel from "./ui/TestimonialCarousel";

// Get all testimonials, sorted by order
const allTestimonials = (await getCollection("testimonials"))
  .filter((t) => t.data.featured)
  .sort((a, b) => a.data.order - b.data.order);

// Process images with getImage() for optimization
const testimonials = await Promise.all(
  allTestimonials.map(async (t) => {
    let optimizedImage: string | undefined = undefined;

    if (t.data.image) {
      try {
        const result = await getImage({
          src: t.data.image,
          width: 112, // 2x size of 56px (size-14 = 3.5rem = 56px)
          height: 112,
          format: "webp",
        });
        optimizedImage = result.src;
      } catch (error) {
        // Gracefully handle missing images - testimonial will use fallback
        console.warn(
          `Could not load image for testimonial "${t.data.name}":`,
          error
        );
      }
    }

    return {
      id: t.id,
      name: t.data.name,
      role: t.data.role,
      company: t.data.company,
      quote: t.data.quote,
      image: optimizedImage,
      website: t.data.website,
    };
  })
);
---

<section id="testimonials" class="relative py-32 md:py-48">
  <!-- Subtle background pattern -->
  <div
    class="pointer-events-none absolute inset-0 overflow-hidden opacity-[0.015]"
  >
    <div
      class="absolute inset-0"
      style="background-image: radial-gradient(circle at 1px 1px, currentColor 1px, transparent 0); background-size: 48px 48px;"
    >
    </div>
  </div>

  <!-- Hat landing spot - decorative element -->
  <div
    data-hat-landing="testimonials"
    class="absolute top-24 right-8 flex size-16 items-center justify-center sm:right-12 md:top-32 md:right-20"
  >
    <div
      class="border-strawhat-yellow size-4 rotate-45 border-r-2 border-b-2 opacity-60"
    >
    </div>
  </div>

  <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
    <div class="space-y-16">
      <!-- Section Header - left on mobile to alternate with Founder (right), centered from md -->
      <div class="relative space-y-6 text-left md:text-center">
        <div class="flex items-center justify-start gap-4 md:justify-center">
          <div class="bg-strawhat-yellow h-px w-12"></div>
          <span
            class="text-strawhat-yellow text-sm font-medium tracking-widest uppercase"
            >Testimonials</span
          >
          <div class="bg-strawhat-yellow hidden h-px w-12 md:block"></div>
        </div>
        <h2
          class="text-strawhat-text text-4xl/tight font-light tracking-tight md:text-6xl"
        >
          What clients say
        </h2>
        <p
          class="text-strawhat-text-light max-w-2xl text-lg/relaxed font-light md:mx-auto"
        >
          Don't just take my word for itâ€”hear from the people who've experienced
          working with Strawhat Digital firsthand.
        </p>
      </div>

      <!-- Testimonials Carousel -->
      {
        testimonials.length > 0 ? (
          <TestimonialCarousel
            testimonials={testimonials}
            client:visible
            autoPlayInterval={6000}
          />
        ) : (
          <div class="text-strawhat-text-light py-12 text-center">
            <p>
              No testimonials yet. Add some to{" "}
              <code class="rounded bg-zinc-100 px-2 py-1 text-sm dark:bg-zinc-800">
                src/content/testimonials/
              </code>
            </p>
          </div>
        )
      }
    </div>
  </div>
</section>
