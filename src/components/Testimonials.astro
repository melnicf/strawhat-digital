---
import { getCollection } from "astro:content";
import { getImage } from "astro:assets";
import { marked } from "marked";
import TestimonialCarousel from "./ui/TestimonialCarousel";
import { getTranslations } from "../utils/i18n";
import type { Locale } from "../utils/i18n";

// Import testimonial images for optimization
import steveRubensImg from "../assets/testimonials/steve-rubens.jpeg";
import jamesKinneyImg from "../assets/testimonials/james-kinney.jpeg";
import mihaelImg from "../assets/testimonials/mihael.png";
import deannaImg from "../assets/testimonials/deanna.jpeg";

// Image map for dynamic lookup
const imageMap: Record<string, typeof steveRubensImg> = {
  "steve-rubens.jpeg": steveRubensImg,
  "james-kinney.jpeg": jamesKinneyImg,
  "mihael.png": mihaelImg,
  "deanna.jpeg": deannaImg,
};

interface Props {
  locale: Locale;
}

const { locale } = Astro.props;
const t = getTranslations(locale);

// Get all testimonials, sorted by order
const allTestimonials = (await getCollection("testimonials"))
  .filter((item) => item.data.featured)
  .sort((a, b) => a.data.order - b.data.order);

// Process images and render markdown content
const testimonials = await Promise.all(
  allTestimonials.map(async (testimonial) => {
    let optimizedImage: string | undefined = undefined;

    if (testimonial.data.image) {
      try {
        // Extract filename from path like "../../assets/testimonials/steve-rubens.jpeg"
        const filename = testimonial.data.image.split("/").pop() || "";
        const imageSrc = imageMap[filename];

        if (imageSrc) {
          const result = await getImage({
            src: imageSrc,
            width: 112, // 2x size of 56px (size-14 = 3.5rem = 56px)
            height: 112,
            format: "webp",
          });
          optimizedImage = result.src;
        }
      } catch (error) {
        // Gracefully handle missing images - testimonial will use fallback
        console.warn(
          `Could not load image for testimonial "${testimonial.data.name}":`,
          error
        );
      }
    }

    // Render markdown body to HTML using marked
    const contentHtml = testimonial.body
      ? await marked.parse(testimonial.body)
      : "";

    return {
      id: testimonial.id,
      name: testimonial.data.name,
      role: testimonial.data.role,
      company: testimonial.data.company,
      content: contentHtml,
      image: optimizedImage,
      website: testimonial.data.website,
    };
  })
);
---

<section id="testimonials" class="relative py-32 md:py-48">
  <!-- Subtle background pattern -->
  <div
    class="pointer-events-none absolute inset-0 overflow-hidden opacity-[0.015]"
  >
    <div
      class="absolute inset-0"
      style="background-image: radial-gradient(circle at 1px 1px, currentColor 1px, transparent 0); background-size: 48px 48px;"
    >
    </div>
  </div>

  <!-- Hat landing spot - decorative element -->
  <div
    data-hat-landing="testimonials"
    class="absolute top-24 right-8 flex size-16 items-center justify-center sm:right-12 md:top-32 md:right-20"
  >
    <div
      class="border-strawhat-yellow size-4 rotate-45 border-r-2 border-b-2 opacity-60"
    >
    </div>
  </div>

  <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
    <div class="space-y-16">
      <!-- Section Header - left on mobile to alternate with Founder (right), centered from md -->
      <div class="relative space-y-6 text-left md:text-center">
        <div class="flex items-center justify-start gap-4 md:justify-center">
          <div class="bg-strawhat-yellow h-px w-12"></div>
          <span
            class="text-strawhat-yellow text-sm font-medium tracking-widest uppercase"
            >{t("testimonials.label")}</span
          >
          <div class="bg-strawhat-yellow hidden h-px w-12 md:block"></div>
        </div>
        <h2
          class="text-strawhat-text text-4xl/tight font-light tracking-tight md:text-6xl"
        >
          {t("testimonials.title")}
        </h2>
        <p
          class="text-strawhat-text-light max-w-2xl text-lg/relaxed font-light md:mx-auto"
        >
          {t("testimonials.intro")}
        </p>
      </div>

      <!-- Testimonials Carousel -->
      {
        testimonials.length > 0 ? (
          <TestimonialCarousel
            testimonials={testimonials}
            client:visible
            autoPlayInterval={10000}
          />
        ) : (
          <div class="text-strawhat-text-light py-12 text-center">
            <p>
              {t("testimonials.noTestimonials")}{" "}
              <code class="rounded bg-zinc-100 px-2 py-1 text-sm dark:bg-zinc-800">
                {t("testimonials.testimonialsPath")}
              </code>
            </p>
          </div>
        )
      }
    </div>
  </div>
</section>
