---
import ThemeToggle from "./ui/ThemeToggle";
import NavbarLogo from "./ui/NavbarLogo";
import { getTranslations } from "../utils/i18n";
import { basePath, SUPPORTED_LOCALES } from "../utils/i18n";
import type { Locale } from "../utils/i18n";

interface Props {
  locale: Locale;
  pathname?: string;
}

const { locale, pathname = "/" } = Astro.props;
const t = getTranslations(locale);
const base = basePath(locale);
// Path without locale prefix for language switcher links
const pathWithoutLocale =
  pathname.replace(/^\/(it|ro)(\/|$)/, "$2").replace(/^$/, "/") || "/";

const localeOptions = SUPPORTED_LOCALES.map((loc) => {
  const href =
    loc === "en"
      ? pathWithoutLocale || "/"
      : `/${loc}${pathWithoutLocale === "/" ? "" : pathWithoutLocale}`;
  return { loc, href, label: t(`locale.${loc}`) };
});

const currentLocaleLabel = t(`locale.${locale}`);

// When not on home, nav links must go to home + hash so the section exists
const homeUrl = base || "/";
const isHomePage = pathWithoutLocale === "/" || pathWithoutLocale === "";
const toSection = (hash: string) =>
  isHomePage ? `#${hash}` : `${homeUrl}#${hash}`;

const navLinks = [
  { href: toSection("hero"), label: t("nav.home"), number: "01" },
  { href: toSection("services"), label: t("nav.services"), number: "02" },
  { href: toSection("case-studies"), label: t("nav.work"), number: "03" },
  { href: toSection("why-us"), label: t("nav.whyUs"), number: "04" },
  { href: toSection("founder"), label: t("nav.about"), number: "05" },
];
const getStartedHref = toSection("get-started");
---

<nav
  class="border-strawhat-text/10 bg-strawhat-bg/80 fixed top-0 right-0 left-0 z-40 border-b backdrop-blur-xl"
>
  <div class="mx-auto max-w-7xl px-2 sm:px-4 md:px-6 lg:px-8">
    <div class="flex h-14 items-center justify-between">
      <div class="h-full min-w-0 shrink-0 overflow-visible">
        <a
          href={base || "/"}
          class="flex h-full min-w-0 items-center overflow-visible transition-opacity hover:opacity-80"
        >
          <NavbarLogo client:load />
        </a>
      </div>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex md:items-center md:space-x-8">
        <div class="ml-10 flex items-center space-x-8">
          {
            navLinks.map((link) => (
              <a
                href={link.href}
                class="text-strawhat-text-light hover:text-strawhat-yellow text-sm font-light tracking-wider transition-colors"
              >
                {link.label}
              </a>
            ))
          }
          <a
            href={getStartedHref}
            class="border-strawhat-yellow text-strawhat-yellow hover:border-strawhat-amber hover:text-strawhat-amber border-b pb-1 text-sm font-light tracking-wider transition-all"
          >
            {t("nav.getStarted")}
          </a>
        </div>
        <div class="flex items-center gap-3">
          <div class="lang-dropdown relative" data-dropdown="desktop">
            <button
              type="button"
              id="lang-dropdown-desktop"
              class="border-strawhat-text/10 bg-strawhat-bg/60 text-strawhat-text hover:border-strawhat-text/20 hover:text-strawhat-yellow flex items-center gap-1.5 rounded-lg border px-3 py-2 text-xs font-medium tracking-wide transition-colors"
              aria-haspopup="listbox"
              aria-expanded="false"
              aria-label="Select language"
            >
              <span>{currentLocaleLabel}</span>
              <svg
                class="lang-dropdown-chevron size-3.5 transition-transform"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div
              id="lang-dropdown-panel-desktop"
              class="lang-dropdown-panel border-strawhat-text/10 bg-strawhat-bg pointer-events-none absolute top-full right-0 z-50 mt-1.5 w-full min-w-0 rounded-lg border opacity-0 shadow-lg backdrop-blur-xl transition-opacity duration-150"
              role="listbox"
              aria-label="Language options"
            >
              {
                localeOptions.map((opt) => (
                  <a
                    href={opt.href}
                    role="option"
                    class={`block px-3 py-2.5 text-xs font-medium tracking-wide transition-colors first:rounded-t-lg last:rounded-b-lg ${
                      opt.loc === locale
                        ? "bg-strawhat-yellow/10 text-strawhat-yellow"
                        : "text-strawhat-text-light hover:bg-strawhat-text/5 hover:text-strawhat-yellow"
                    }`}
                    aria-selected={opt.loc === locale}
                  >
                    {opt.label}
                  </a>
                ))
              }
            </div>
          </div>
          <ThemeToggle client:load />
        </div>
      </div>

      <!-- Mobile: Language dropdown & Theme Toggle -->
      <div class="flex items-center gap-3 md:hidden">
        <div class="lang-dropdown relative" data-dropdown="mobile">
          <button
            type="button"
            id="lang-dropdown-mobile"
            class="border-strawhat-text/10 bg-strawhat-bg/60 text-strawhat-text hover:border-strawhat-text/20 hover:text-strawhat-yellow flex items-center gap-1 rounded-md border px-2 py-1.5 text-xs font-medium tracking-wide transition-colors"
            aria-haspopup="listbox"
            aria-expanded="false"
            aria-label="Select language"
          >
            <span>{currentLocaleLabel}</span>
            <svg
              class="lang-dropdown-chevron size-3 transition-transform"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div
            id="lang-dropdown-panel-mobile"
            class="lang-dropdown-panel border-strawhat-text/10 bg-strawhat-bg pointer-events-none absolute top-full right-0 z-50 mt-1 w-[90px] rounded-md border opacity-0 shadow-lg backdrop-blur-xl transition-opacity duration-150"
            role="listbox"
            aria-label="Language options"
          >
            {
              localeOptions.map((opt) => (
                <a
                  href={opt.href}
                  role="option"
                  class={`block px-2.5 py-2 text-xs font-medium tracking-wide transition-colors first:rounded-t-md last:rounded-b-md ${
                    opt.loc === locale
                      ? "bg-strawhat-yellow/10 text-strawhat-yellow"
                      : "text-strawhat-text-light hover:bg-strawhat-text/5 hover:text-strawhat-yellow"
                  }`}
                  aria-selected={opt.loc === locale}
                >
                  {opt.label}
                </a>
              ))
            }
          </div>
        </div>
        <ThemeToggle client:load />
        <button
          id="mobile-menu-button"
          type="button"
          class="relative z-70 flex size-10 items-center justify-center focus:outline-none"
          aria-expanded="false"
          aria-label={t("nav.toggleMenu")}
        >
          <div class="hamburger-icon">
            <span class="hamburger-line hamburger-line-1"></span>
            <span class="hamburger-line hamburger-line-2"></span>
            <span class="hamburger-line hamburger-line-3"></span>
          </div>
        </button>
      </div>
    </div>
  </div>
</nav>

<!-- Full-screen Mobile Menu Overlay -->
<div
  id="mobile-menu"
  class="mobile-menu-overlay pointer-events-none fixed inset-0 z-60 opacity-0 md:hidden"
>
  <!-- Backdrop -->
  <div class="bg-strawhat-bg/98 absolute inset-0 backdrop-blur-2xl"></div>

  <!-- Menu Content -->
  <div class="relative flex h-full flex-col justify-center px-8 sm:px-12">
    <!-- Navigation Links -->
    <nav class="space-y-2">
      {
        navLinks.map((link, index) => (
          <a
            href={link.href}
            class="mobile-menu-link group flex items-center gap-6 py-4"
            style={`--link-delay: ${index * 50}ms`}
          >
            <span class="text-strawhat-yellow/40 group-hover:text-strawhat-yellow text-sm font-light tracking-wider tabular-nums transition-colors duration-300">
              {link.number}
            </span>
            <span class="text-strawhat-text group-hover:text-strawhat-yellow text-4xl font-light tracking-tight transition-colors duration-300 sm:text-5xl">
              {link.label}
            </span>
            <div class="bg-strawhat-yellow/0 group-hover:bg-strawhat-yellow/60 ml-4 h-px w-0 transition-all duration-300 group-hover:w-12" />
          </a>
        ))
      }

      <!-- Get Started CTA -->
      <div class="mobile-menu-link pt-8" style="--link-delay: 250ms">
        <div class="flex items-center gap-4 pb-4">
          <div class="bg-strawhat-yellow h-px w-8"></div>
          <span
            class="text-strawhat-yellow text-xs font-medium tracking-widest uppercase"
            >{t("nav.startProject")}</span
          >
        </div>
        <a href={getStartedHref} class="group inline-flex items-center gap-4">
          <span
            class="text-strawhat-yellow group-hover:text-strawhat-amber text-3xl font-light tracking-tight transition-colors sm:text-4xl"
          >
            {t("nav.getStarted")}
          </span>
          <svg
            class="text-strawhat-yellow group-hover:text-strawhat-amber size-6 transition-all duration-300 group-hover:translate-x-2"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <path d="M5 12h14M12 5l7 7-7 7"></path>
          </svg>
        </a>
      </div>
    </nav>

    <!-- Bottom info -->
    <div
      class="mobile-menu-link absolute right-8 bottom-8 left-8 sm:inset-x-12"
      style="--link-delay: 300ms"
    >
      <div
        class="border-strawhat-text/10 flex items-center justify-between border-t pt-6"
      >
        <a
          href="mailto:hello@strawhat.digital"
          class="text-strawhat-text-light hover:text-strawhat-yellow text-sm font-light tracking-wider transition-colors"
        >
          hello@strawhat.digital
        </a>
      </div>
    </div>
  </div>
</div>

<style>
  /* Animated hamburger icon */
  .hamburger-icon {
    width: 24px;
    height: 18px;
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .hamburger-line {
    display: block;
    width: 100%;
    height: 2px;
    background-color: var(--strawhat-text);
    border-radius: 2px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform-origin: center;
  }

  .hamburger-line-2 {
    width: 75%;
    margin-left: auto;
  }

  /* Hamburger to X animation */
  .menu-open .hamburger-line-1 {
    transform: translateY(8px) rotate(45deg);
  }

  .menu-open .hamburger-line-2 {
    opacity: 0;
    transform: scaleX(0);
  }

  .menu-open .hamburger-line-3 {
    transform: translateY(-8px) rotate(-45deg);
  }

  .menu-open .hamburger-line {
    background-color: var(--strawhat-yellow);
  }

  /* Mobile menu overlay transitions */
  .mobile-menu-overlay {
    transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .mobile-menu-overlay.menu-visible {
    opacity: 1;
    pointer-events: auto;
  }

  /* Menu link animations */
  .mobile-menu-link {
    opacity: 0;
    transform: translateX(-20px);
    transition:
      opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
      transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    transition-delay: var(--link-delay, 0ms);
  }

  .menu-visible .mobile-menu-link {
    opacity: 1;
    transform: translateX(0);
  }

  /* Prevent body scroll when menu is open */
  :global(body.menu-open) {
    overflow: hidden;
  }

  /* Language dropdown: chevron rotation when open */
  .lang-dropdown-open .lang-dropdown-chevron {
    transform: rotate(180deg);
  }
</style>

<script>
  // Mobile menu toggle with animations
  const menuButton = document.getElementById("mobile-menu-button");
  const mobileMenu = document.getElementById("mobile-menu");

  if (menuButton && mobileMenu) {
    let isOpen = false;

    const openMenu = () => {
      isOpen = true;
      menuButton.classList.add("menu-open");
      mobileMenu.classList.add("menu-visible");
      document.body.classList.add("menu-open");
      menuButton.setAttribute("aria-expanded", "true");
    };

    const closeMenu = () => {
      isOpen = false;
      menuButton.classList.remove("menu-open");
      mobileMenu.classList.remove("menu-visible");
      document.body.classList.remove("menu-open");
      menuButton.setAttribute("aria-expanded", "false");
    };

    menuButton.addEventListener("click", () => {
      if (isOpen) {
        closeMenu();
      } else {
        openMenu();
      }
    });

    // Close menu when clicking a link and handle navigation
    const mobileMenuLinks = mobileMenu.querySelectorAll("a[href^='#']");
    mobileMenuLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        const href = link.getAttribute("href");
        if (href && href.startsWith("#")) {
          e.preventDefault();

          // Remove overflow hidden first to allow scrolling
          document.body.classList.remove("menu-open");

          // Get target element
          const targetId = href.substring(1);
          const targetElement = document.getElementById(targetId);

          if (targetElement) {
            // Calculate scroll position accounting for navbar + breathing room
            const scrollOffset = 64; // 4rem to match scroll-margin-top
            const targetPosition = targetElement.offsetTop - scrollOffset;

            // Scroll to calculated position
            window.scrollTo({
              top: Math.max(0, targetPosition),
              behavior: "smooth",
            });
          }

          // Close menu visually after a short delay
          setTimeout(() => {
            closeMenu();
          }, 100);
        }
      });
    });

    // Handle non-anchor links (like mailto)
    const externalLinks = mobileMenu.querySelectorAll("a:not([href^='#'])");
    externalLinks.forEach((link) => {
      link.addEventListener("click", closeMenu);
    });

    // Close menu on escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && isOpen) {
        closeMenu();
      }
    });

    // Close menu when resizing to desktop
    window.addEventListener("resize", () => {
      if (window.innerWidth >= 768 && isOpen) {
        closeMenu();
      }
    });
  }

  // Language dropdown toggle
  document.querySelectorAll(".lang-dropdown").forEach((wrapper) => {
    const btn = wrapper.querySelector("button");
    const panel = wrapper.querySelector(".lang-dropdown-panel");
    if (!btn || !panel) return;

    const open = () => {
      wrapper.classList.add("lang-dropdown-open");
      panel.classList.remove("opacity-0", "pointer-events-none");
      panel.classList.add("opacity-100", "pointer-events-auto");
      btn.setAttribute("aria-expanded", "true");
    };

    const close = () => {
      wrapper.classList.remove("lang-dropdown-open");
      panel.classList.add("opacity-0", "pointer-events-none");
      panel.classList.remove("opacity-100", "pointer-events-auto");
      btn.setAttribute("aria-expanded", "false");
    };

    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const isOpen = wrapper.classList.contains("lang-dropdown-open");
      if (isOpen) close();
      else open();
    });

    document.addEventListener("click", (e) => {
      if (!wrapper.contains(e.target as Node)) close();
    });

    document.addEventListener("keydown", (e) => {
      if (
        e.key === "Escape" &&
        wrapper.classList.contains("lang-dropdown-open")
      ) {
        close();
      }
    });
  });
</script>
