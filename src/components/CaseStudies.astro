---
import { getCollection, type CollectionEntry } from "astro:content";
import CaseStudyCard from "./CaseStudyCard.astro";

type CaseStudy = CollectionEntry<"case-studies">;

// Get all featured case studies, sorted by order
const caseStudies = (await getCollection("case-studies"))
  .filter((study: CaseStudy) => study.data.featured)
  .sort((a: CaseStudy, b: CaseStudy) => a.data.order - b.data.order)
  .slice(0, 3);
---

<section id="case-studies" class="relative py-32 md:py-48">
  <!-- Subtle background pattern -->
  <div
    class="pointer-events-none absolute inset-0 overflow-hidden opacity-[0.015]"
  >
    <div
      class="absolute inset-0"
      style="background-image: radial-gradient(circle at 1px 1px, currentColor 1px, transparent 0); background-size: 48px 48px;"
    >
    </div>
  </div>

  <!-- Hat landing spot - decorative hook near heading (LEFT on mobile, RIGHT on desktop) -->
  <div
    data-hat-landing="case-studies"
    class="absolute top-24 left-8 flex size-16 items-center justify-center sm:left-12 md:top-32 md:right-16 md:left-auto"
  >
    <div
      class="border-strawhat-yellow size-4 rotate-45 border-t-2 border-l-2 opacity-60"
    >
    </div>
  </div>

  <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
    <div class="space-y-16">
      <!-- Section Header -->
      <div class="relative space-y-6">
        <div class="flex items-center justify-end gap-4 sm:justify-start">
          <div class="bg-strawhat-yellow h-px w-12"></div>
          <span
            class="text-strawhat-yellow text-sm font-medium tracking-widest uppercase"
            >Case Studies</span
          >
        </div>
        <h2
          class="text-strawhat-text text-4xl/tight font-light tracking-tight md:text-6xl"
        >
          Selected work
        </h2>
        <p
          class="text-strawhat-text-light max-w-2xl text-lg/relaxed font-light"
        >
          A glimpse into some of our recent projects. Each one represents a
          unique challenge and a tailored solution.
        </p>
      </div>

      <!-- Case Studies Grid -->
      <div class="case-studies-grid grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {
          caseStudies.map((study: CaseStudy) => (
            <CaseStudyCard
              slug={study.id}
              title={study.data.title}
              client={study.data.client}
              description={study.data.description}
              image={study.data.image}
              tags={study.data.tags}
            />
          ))
        }
      </div>

      <!-- View all link -->
      <div class="flex justify-center">
        <a
          href="/case-studies"
          class="group text-strawhat-text hover:text-strawhat-yellow inline-flex items-center gap-2 text-sm font-medium transition-colors"
        >
          View all case studies
          <svg
            class="size-4 transition-transform duration-300 group-hover:translate-x-1"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M5 12h14M12 5l7 7-7 7"></path>
          </svg>
        </a>
      </div>
    </div>
  </div>
</section>

<script>
  // Desktop only - interactive effects (optimized with RAF and throttling)
  function initCaseStudyEffects() {
    if (window.innerWidth < 768) return;

    const caseStudyCards = document.querySelectorAll(".case-study-card");
    const maxTilt = 15;

    caseStudyCards.forEach((card) => {
      // Check if already initialized
      if ((card as any).__effectsInitialized) return;
      (card as any).__effectsInitialized = true;

      const inner = card.querySelector(".card-inner") as HTMLElement;
      if (!inner) return;

      // Cache rect to avoid recalculating on every mousemove
      let rect = card.getBoundingClientRect();
      let rafId: number | null = null;
      let pendingUpdate = false;

      // Throttle updates using requestAnimationFrame for smooth 60fps
      const updateCard = (e: Event) => {
        const event = e as MouseEvent;
        if (!pendingUpdate) {
          pendingUpdate = true;
          rafId = requestAnimationFrame(() => {
            rect = card.getBoundingClientRect();

            // Update highlight position
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            (card as HTMLElement).style.setProperty("--spot-x", `${x}px`);
            (card as HTMLElement).style.setProperty("--spot-y", `${y}px`);

            // Calculate mouse position relative to card center
            const xRel = (event.clientX - rect.left) / rect.width - 0.5;
            const yRel = (event.clientY - rect.top) / rect.height - 0.5;

            // Calculate rotation
            const rotateY = xRel * maxTilt;
            const rotateX = -yRel * maxTilt;

            inner.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            pendingUpdate = false;
          });
        }
      };

      // Use passive listener for better scroll performance
      card.addEventListener("mousemove", updateCard, { passive: true });

      card.addEventListener("mouseleave", () => {
        // Cancel pending animation frame
        if (rafId !== null) {
          cancelAnimationFrame(rafId);
          pendingUpdate = false;
        }
        // Reset to flat
        inner.style.transform = "rotateX(0deg) rotateY(0deg)";
      });

      // Recalculate rect on resize
      const handleResize = () => {
        rect = card.getBoundingClientRect();
      };
      window.addEventListener("resize", handleResize, { passive: true });
    });
  }

  // Wait for DOM to be ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initCaseStudyEffects);
  } else {
    initCaseStudyEffects();
  }
</script>
