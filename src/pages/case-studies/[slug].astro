---
import { getCollection, render, type CollectionEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.astro";

type CaseStudy = CollectionEntry<"case-studies">;
type MediaItem = NonNullable<CaseStudy["data"]["media"]>[number];

export async function getStaticPaths() {
  const caseStudies = await getCollection("case-studies");
  return caseStudies.map((study: CaseStudy) => ({
    params: { slug: study.id },
    props: { study },
  }));
}

interface Props {
  study: CaseStudy;
}

const { study } = Astro.props;
const { Content } = await render(study);
---

<Layout>
  <Navbar />

  <article class="relative">
    <!-- Hero Section -->
    <section class="relative pt-12 pb-10 sm:pt-16 sm:pb-12 md:pt-20 md:pb-16">
      <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8">
        <!-- Back link -->
        <a
          href="/#case-studies"
          class="group text-strawhat-text-light hover:text-strawhat-yellow mb-6 inline-flex items-center gap-2 text-sm transition-colors sm:mb-8"
        >
          <svg
            class="size-4 transition-transform duration-300 group-hover:-translate-x-1"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M19 12H5M12 19l-7-7 7-7"></path>
          </svg>
          Back
        </a>

        <!-- Header -->
        <div class="space-y-4 sm:space-y-5">
          <div class="flex items-center gap-3">
            <div class="bg-strawhat-yellow h-px w-8 sm:w-12"></div>
            <span
              class="text-strawhat-yellow text-sm font-medium tracking-widest uppercase"
            >
              {study.data.client}
            </span>
          </div>

          <h1
            class="text-strawhat-text text-3xl/tight font-light tracking-tight sm:text-4xl md:text-5xl lg:text-6xl"
          >
            {study.data.title}
          </h1>

          <p
            class="text-strawhat-text-light max-w-2xl text-lg/relaxed font-light sm:text-xl/relaxed"
          >
            {study.data.description}
          </p>
        </div>

        <!-- Meta row -->
        <div
          class="border-strawhat-text/10 mt-6 flex flex-wrap items-center gap-6 border-t pt-4 sm:mt-8 sm:gap-8"
        >
          {
            study.data.year && (
              <div>
                <span class="text-strawhat-text-light block text-xs font-medium tracking-widest uppercase">
                  Year
                </span>
                <span class="text-strawhat-text mt-1 block text-sm font-light">
                  {study.data.year}
                </span>
              </div>
            )
          }
          <div>
            <span
              class="text-strawhat-text-light block text-xs font-medium tracking-widest uppercase"
            >
              Technologies
            </span>
            <div class="mt-1 flex flex-wrap gap-x-2 gap-y-1">
              {
                study.data.tags.map((tag: string, i: number) => (
                  <span class="text-strawhat-text text-sm font-light">
                    {tag}
                    {i < study.data.tags.length - 1 ? "," : ""}
                  </span>
                ))
              }
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Media Gallery Slideshow -->
    {
      study.data.media && study.data.media.length > 0 && (
        <section class="pb-16 sm:pb-20 md:pb-24">
          <div class="slideshow mx-auto w-full max-w-5xl px-4 sm:px-6 lg:px-8">
            {/* Screen mockup with nav arrows */}
            <div class="group/slideshow relative flex items-center">
              {/* Left arrow */}
              <button
                type="button"
                id="slide-prev"
                class="hover:bg-strawhat-yellow absolute -left-4 z-30 flex size-11 items-center justify-center rounded-full border border-zinc-200 bg-white text-zinc-600 shadow-md transition-all duration-200 hover:scale-110 hover:border-transparent hover:text-white hover:shadow-lg sm:-left-6 md:-left-8 md:size-12 md:opacity-0 md:group-hover/slideshow:opacity-100 lg:-left-12 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-400"
                aria-label="Previous slide"
              >
                <svg
                  class="size-5 md:size-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M15 19l-7-7 7-7" />
                </svg>
              </button>

              {/* MacBook frame */}
              <div class="w-full">
                {/* Lid / Screen assembly */}
                <div class="relative rounded-t-2xl bg-linear-to-b from-zinc-700 to-zinc-800 p-[3px] shadow-xl sm:rounded-t-3xl sm:p-1 dark:from-zinc-800 dark:to-zinc-900">
                  {/* Inner bezel */}
                  <div class="rounded-t-[13px] bg-zinc-900 p-2 sm:rounded-t-[20px] sm:p-2.5 md:p-3">
                    {/* Camera notch */}
                    <div class="mx-auto mb-1.5 flex items-center justify-center gap-1 sm:mb-2">
                      <div class="size-1.5 rounded-full bg-zinc-800 ring-1 ring-zinc-700 sm:size-2" />
                    </div>
                    {/* Screen */}
                    <div class="relative aspect-video w-full overflow-hidden rounded bg-black sm:rounded-md">
                      {study.data.media.map(
                        (item: MediaItem, index: number) => (
                          <div
                            class:list={[
                              "slide absolute inset-0 transition-opacity duration-500",
                              index === 0
                                ? "opacity-100"
                                : "pointer-events-none opacity-0",
                            ]}
                            data-slide-index={index}
                          >
                            {item.type === "video" ? (
                              <video
                                controls
                                muted
                                preload="metadata"
                                playsinline
                                poster={item.poster}
                                class="slideshow-video size-full object-contain"
                              >
                                <source src={item.src} type="video/mp4" />
                              </video>
                            ) : (
                              <img
                                src={item.src}
                                alt={item.alt}
                                class="size-full object-contain"
                              />
                            )}
                          </div>
                        )
                      )}
                      {/* Screen reflection */}
                      <div class="pointer-events-none absolute inset-0 bg-linear-to-br from-white/[0.07] via-transparent to-transparent" />
                    </div>
                  </div>
                </div>

                {/* Base / Keyboard deck */}
                <div class="relative">
                  {/* Hinge */}
                  <div class="h-1.5 bg-linear-to-b from-zinc-500 to-zinc-400 sm:h-2 dark:from-zinc-700 dark:to-zinc-600" />
                  {/* Notch indent */}
                  <div class="absolute top-0 left-1/2 h-1.5 w-14 -translate-x-1/2 rounded-b bg-zinc-400 sm:h-2 sm:w-20 dark:bg-zinc-600" />
                  {/* Keyboard base */}
                  <div class="h-3 rounded-b-lg border-x border-b border-zinc-300 bg-linear-to-b from-zinc-200 to-zinc-100 shadow-sm sm:h-4 sm:rounded-b-xl md:h-5 dark:border-zinc-800 dark:from-zinc-700 dark:to-zinc-800" />
                </div>

                {/* Shadow */}
                <div class="mx-auto mt-4 h-4 w-4/5 rounded-full bg-black/15 blur-xl sm:mt-5 dark:bg-black/30" />
              </div>

              {/* Right arrow */}
              <button
                type="button"
                id="slide-next"
                class="hover:bg-strawhat-yellow absolute -right-4 z-30 flex size-11 items-center justify-center rounded-full border border-zinc-200 bg-white text-zinc-600 shadow-md transition-all duration-200 hover:scale-110 hover:border-transparent hover:text-white hover:shadow-lg sm:-right-6 md:-right-8 md:size-12 md:opacity-0 md:group-hover/slideshow:opacity-100 lg:-right-12 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-400"
                aria-label="Next slide"
              >
                <svg
                  class="size-5 md:size-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M9 5l7 7-7 7" />
                </svg>
              </button>
            </div>

            {/* Caption + dots */}
            <div class="mt-8 flex flex-col gap-4 sm:mt-10 sm:flex-row sm:items-center sm:justify-between">
              <div class="flex-1">
                {study.data.media.map((item: MediaItem, index: number) => (
                  <p
                    class:list={[
                      "slide-caption text-strawhat-text-light text-sm/relaxed font-light md:text-base/relaxed",
                      index === 0 ? "block" : "hidden",
                    ]}
                    data-caption-index={index}
                  >
                    {item.caption || item.alt}
                  </p>
                ))}
              </div>

              {/* Dots */}
              <div class="flex shrink-0 items-center gap-2">
                {study.data.media.map((item: MediaItem, index: number) => (
                  <button
                    type="button"
                    class:list={[
                      "slide-dot flex items-center justify-center rounded-full transition-all",
                      item.type === "video" ? "size-4" : "size-2",
                      index === 0
                        ? "bg-strawhat-yellow text-white"
                        : "bg-zinc-300 hover:bg-zinc-400 dark:bg-zinc-600 dark:hover:bg-zinc-500",
                    ]}
                    data-dot-index={index}
                    data-type={item.type}
                    aria-label={`Go to slide ${index + 1}`}
                  >
                    {item.type === "video" && (
                      <svg
                        class="size-2"
                        fill="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path d="M8 5v14l11-7z" />
                      </svg>
                    )}
                  </button>
                ))}
              </div>
            </div>
          </div>
        </section>
      )
    }

    {/* Fallback: Show hero image if no media gallery */}
    {
      (!study.data.media || study.data.media.length === 0) && (
        <section class="pb-16 sm:pb-20 md:pb-24">
          <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8">
            <div class="overflow-hidden rounded-xl border border-zinc-200/60 sm:rounded-2xl dark:border-zinc-800/60">
              <img
                src={study.data.image}
                alt={study.data.title}
                class="aspect-video w-full object-cover"
              />
            </div>
          </div>
        </section>
      )
    }

    <!-- Content -->
    <section class="py-12 sm:py-16 md:py-20">
      <div class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8">
        <div class="case-study-content">
          <Content />
        </div>
      </div>
    </section>

    <!-- CTA -->
    <section class="border-strawhat-text/10 border-t py-16 sm:py-20 md:py-24">
      <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8">
        <div class="space-y-6 text-center">
          <h2
            class="text-strawhat-text text-xl font-light tracking-tight sm:text-2xl md:text-3xl"
          >
            Interested in working together?
          </h2>
          <a
            href="/#get-started"
            class="border-strawhat-yellow text-strawhat-yellow hover:border-strawhat-amber hover:text-strawhat-amber inline-block border-b-2 pb-1 text-base font-light tracking-wider transition-all sm:text-lg"
          >
            Start a project
          </a>
        </div>
      </div>
    </section>
  </article>
</Layout>

<style is:global>
  /* Case study content styling - minimal, on-theme */
  .case-study-content h2 {
    color: var(--strawhat-text);
    font-size: 1.5rem;
    font-weight: 300;
    letter-spacing: -0.025em;
    margin-top: 3rem;
    margin-bottom: 1.25rem;
  }

  .case-study-content h2:first-child {
    margin-top: 0;
  }

  .case-study-content h3 {
    color: var(--strawhat-text);
    font-size: 1.125rem;
    font-weight: 400;
    letter-spacing: -0.025em;
    margin-top: 2.5rem;
    margin-bottom: 1.25rem;
  }

  .case-study-content p {
    color: var(--strawhat-text-light);
    font-size: 1rem;
    font-weight: 300;
    line-height: 1.8;
    margin-bottom: 1.5rem;
  }

  .case-study-content ul {
    color: var(--strawhat-text-light);
    font-weight: 300;
    list-style: none;
    padding-left: 0;
    margin-bottom: 2rem;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem 2rem;
  }

  .case-study-content li {
    position: relative;
    padding-left: 1rem;
    line-height: 1.6;
    font-size: 0.9375rem;
  }

  .case-study-content li::before {
    content: "";
    position: absolute;
    left: 0;
    top: 0.55em;
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: var(--strawhat-yellow);
  }

  /* Responsive: single column on mobile */
  @media (max-width: 640px) {
    .case-study-content ul {
      grid-template-columns: 1fr;
      gap: 0.625rem;
    }
  }

  .case-study-content strong {
    color: var(--strawhat-text);
    font-weight: 500;
  }

  .case-study-content a {
    color: var(--strawhat-yellow);
    text-decoration: none;
    border-bottom: 1px solid currentColor;
    transition: opacity 0.2s;
  }

  .case-study-content a:hover {
    opacity: 0.7;
  }

  /* Minimal video controls - only play button and progress bar */
  .slideshow-video {
    background: #000;
  }

  .slideshow-video::-webkit-media-controls-panel {
    background: linear-gradient(to top, rgba(0, 0, 0, 0.5) 0%, transparent 50%);
    padding: 0 8px 6px;
  }

  /* Hide unwanted controls */
  .slideshow-video::-webkit-media-controls-mute-button,
  .slideshow-video::-webkit-media-controls-volume-slider,
  .slideshow-video::-webkit-media-controls-fullscreen-button,
  .slideshow-video::-webkit-media-controls-current-time-display,
  .slideshow-video::-webkit-media-controls-time-remaining-display,
  .slideshow-video::-webkit-media-controls-toggle-closed-captions-button,
  .slideshow-video::-webkit-media-controls-picture-in-picture-button,
  .slideshow-video::-webkit-media-controls-overflow-button {
    display: none !important;
  }

  /* Style play button */
  .slideshow-video::-webkit-media-controls-play-button {
    opacity: 0.9;
    transform: scale(0.9);
  }

  /* Style progress bar */
  .slideshow-video::-webkit-media-controls-timeline {
    height: 3px;
    border-radius: 3px;
    margin: 0 8px;
  }
</style>

<script>
  // Minimal Slideshow with Auto-advance
  document.addEventListener("DOMContentLoaded", () => {
    const slideshow = document.querySelector<HTMLElement>(".slideshow");
    if (!slideshow) return;

    const slides = slideshow.querySelectorAll<HTMLElement>(".slide");
    const captions = slideshow.querySelectorAll<HTMLElement>(".slide-caption");
    const dots = slideshow.querySelectorAll<HTMLButtonElement>(".slide-dot");
    const prevBtn = document.getElementById("slide-prev");
    const nextBtn = document.getElementById("slide-next");

    if (slides.length === 0) return;

    let currentIndex = 0;
    const totalSlides = slides.length;
    const AUTO_ADVANCE_INTERVAL = 5000; // 5 seconds
    let autoAdvanceTimer: ReturnType<typeof setInterval> | null = null;
    let isHovering = false;
    let isVideoPlaying = false;

    function shouldPause() {
      return isHovering || isVideoPlaying;
    }

    function showSlide(index: number) {
      // Pause all videos
      slides.forEach((slide) => {
        const video = slide.querySelector("video");
        if (video) video.pause();
      });

      // Update slides
      slides.forEach((slide, i) => {
        if (i === index) {
          slide.classList.remove("opacity-0", "pointer-events-none");
          slide.classList.add("opacity-100");
        } else {
          slide.classList.add("opacity-0", "pointer-events-none");
          slide.classList.remove("opacity-100");
        }
      });

      // Update captions
      captions.forEach((caption, i) => {
        caption.classList.toggle("hidden", i !== index);
        caption.classList.toggle("block", i === index);
      });

      // Update dots
      dots.forEach((dot, i) => {
        const isVideo = dot.dataset.type === "video";
        if (i === index) {
          dot.classList.add("bg-strawhat-yellow");
          if (isVideo) {
            dot.classList.add("text-white");
          } else {
            dot.classList.add("w-6");
          }
          dot.classList.remove(
            "bg-zinc-300",
            "dark:bg-zinc-600",
            "text-zinc-500",
            "dark:text-zinc-400"
          );
        } else {
          dot.classList.remove("bg-strawhat-yellow", "text-white");
          if (!isVideo) {
            dot.classList.remove("w-6");
          }
          dot.classList.add(
            "bg-zinc-300",
            "dark:bg-zinc-600",
            "text-zinc-500",
            "dark:text-zinc-400"
          );
        }
      });

      currentIndex = index;
    }

    function nextSlide() {
      showSlide((currentIndex + 1) % totalSlides);
    }

    function prevSlide() {
      showSlide((currentIndex - 1 + totalSlides) % totalSlides);
    }

    // Auto-advance functions
    function startAutoAdvance() {
      if (autoAdvanceTimer) return;
      autoAdvanceTimer = setInterval(() => {
        if (!shouldPause()) nextSlide();
      }, AUTO_ADVANCE_INTERVAL);
    }

    function stopAutoAdvance() {
      if (autoAdvanceTimer) {
        clearInterval(autoAdvanceTimer);
        autoAdvanceTimer = null;
      }
    }

    function resetAutoAdvance() {
      stopAutoAdvance();
      startAutoAdvance();
    }

    // Pause on hover
    slideshow.addEventListener("mouseenter", () => {
      isHovering = true;
    });

    slideshow.addEventListener("mouseleave", () => {
      isHovering = false;
    });

    // Pause when video is playing, auto-advance when ended
    slides.forEach((slide) => {
      const video = slide.querySelector("video");
      if (video) {
        video.addEventListener("play", () => {
          isVideoPlaying = true;
        });
        video.addEventListener("pause", () => {
          isVideoPlaying = false;
        });
        video.addEventListener("ended", () => {
          isVideoPlaying = false;
          // Auto-advance to next slide when video ends
          nextSlide();
          resetAutoAdvance();
        });
      }
    });

    // Navigation event listeners (reset timer on manual navigation)
    prevBtn?.addEventListener("click", () => {
      prevSlide();
      resetAutoAdvance();
    });

    nextBtn?.addEventListener("click", () => {
      nextSlide();
      resetAutoAdvance();
    });

    dots.forEach((dot) => {
      dot.addEventListener("click", () => {
        const index = parseInt(dot.dataset.dotIndex || "0", 10);
        showSlide(index);
        resetAutoAdvance();
      });
    });

    // Keyboard navigation
    document.addEventListener("keydown", (e) => {
      const rect = slideshow.getBoundingClientRect();
      const inView = rect.top < window.innerHeight && rect.bottom > 0;
      if (!inView) return;

      if (e.key === "ArrowRight") {
        nextSlide();
        resetAutoAdvance();
      }
      if (e.key === "ArrowLeft") {
        prevSlide();
        resetAutoAdvance();
      }
    });

    // Start auto-advance when slideshow is in viewport
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            startAutoAdvance();
          } else {
            stopAutoAdvance();
          }
        });
      },
      { threshold: 0.3 }
    );

    observer.observe(slideshow);
  });
</script>
