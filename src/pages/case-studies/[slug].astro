---
import { getCollection, render, type CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.astro";
import CaseStudySlideshow from "../../components/ui/CaseStudySlideshow";
import { resolveImage } from "../../utils/imageMap";

type CaseStudy = CollectionEntry<"case-studies">;

export async function getStaticPaths() {
  const caseStudies = await getCollection("case-studies");
  return caseStudies.map((study: CaseStudy) => ({
    params: { slug: study.id },
    props: { study },
  }));
}

interface Props {
  study: CaseStudy;
}

const { study } = Astro.props;
const { Content } = await render(study);

// Resolve media images for optimization
const resolvedMedia = study.data.media?.map((item) => {
  const resolved = { ...item };
  if (item.type === "image") {
    const resolvedSrc = resolveImage(item.src);
    resolved.src =
      typeof resolvedSrc === "string" ? resolvedSrc : resolvedSrc.src;
    if (item.srcMobile) {
      const resolvedMobile = resolveImage(item.srcMobile);
      resolved.srcMobile =
        typeof resolvedMobile === "string"
          ? resolvedMobile
          : resolvedMobile.src;
    }
    if (item.poster) {
      const resolvedPoster = resolveImage(item.poster);
      resolved.poster =
        typeof resolvedPoster === "string"
          ? resolvedPoster
          : resolvedPoster.src;
    }
  } else if (item.type === "video") {
    // Videos stay as paths (they're in public/), but resolve poster images
    if (item.poster) {
      const resolvedPoster = resolveImage(item.poster);
      resolved.poster =
        typeof resolvedPoster === "string"
          ? resolvedPoster
          : resolvedPoster.src;
    }
  }
  return resolved;
});
---

<Layout>
  <Navbar />

  <article class="relative">
    <!-- Hero Section -->
    <section class="relative pt-20 pb-10 sm:pt-16 sm:pb-12 md:pt-20 md:pb-16">
      <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8">
        <!-- Back link -->
        <a
          href="/#case-studies"
          class="group text-strawhat-text-light hover:text-strawhat-yellow mb-6 inline-flex items-center gap-2 text-sm transition-colors sm:mb-8"
        >
          <svg
            class="size-4 transition-transform duration-300 group-hover:-translate-x-1"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M19 12H5M12 19l-7-7 7-7"></path>
          </svg>
          Back
        </a>

        <!-- Header -->
        <div class="space-y-4 sm:space-y-5">
          <div class="flex items-center gap-3">
            <div class="bg-strawhat-yellow h-px w-8 sm:w-12"></div>
            <span
              class="text-strawhat-yellow text-sm font-medium tracking-widest uppercase"
            >
              {study.data.client}
            </span>
          </div>

          <h1
            class="text-strawhat-text text-3xl/tight font-light tracking-tight sm:text-4xl md:text-5xl lg:text-6xl"
          >
            {study.data.title}
          </h1>

          <p
            class="text-strawhat-text-light max-w-2xl text-lg/relaxed font-light sm:text-xl/relaxed"
          >
            {study.data.description}
          </p>
        </div>

        <!-- Meta row -->
        <div
          class="border-strawhat-text/10 mt-6 flex flex-wrap items-center gap-6 border-t pt-4 sm:mt-8 sm:gap-8"
        >
          {
            study.data.year && (
              <div>
                <span class="text-strawhat-text-light block text-xs font-medium tracking-widest uppercase">
                  Year
                </span>
                <span class="text-strawhat-text mt-1 block text-sm font-light">
                  {study.data.year}
                </span>
              </div>
            )
          }
          <div>
            <span
              class="text-strawhat-text-light block text-xs font-medium tracking-widest uppercase"
            >
              Technologies
            </span>
            <div class="mt-1 flex flex-wrap gap-x-2 gap-y-1">
              {
                study.data.tags.map((tag: string, i: number) => (
                  <span class="text-strawhat-text text-sm font-light">
                    {tag}
                    {i < study.data.tags.length - 1 ? "," : ""}
                  </span>
                ))
              }
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Media Gallery Slideshow -->
    {
      resolvedMedia && resolvedMedia.length > 0 && (
        <section class="pb-16 sm:pb-20 md:pb-24">
          <CaseStudySlideshow media={resolvedMedia} client:load />
        </section>
      )
    }

    {/* Fallback: Show hero image if no media gallery */}
    {
      (!study.data.media || study.data.media.length === 0) && (
        <section class="pb-16 sm:pb-20 md:pb-24">
          <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8">
            <div class="overflow-hidden rounded-xl border border-zinc-200/60 sm:rounded-2xl dark:border-zinc-800/60">
              <Image
                src={resolveImage(study.data.image)}
                alt={study.data.title}
                class="aspect-video w-full object-cover"
                width={1600}
                height={900}
              />
            </div>
          </div>
        </section>
      )
    }

    <!-- Content -->
    <section class="py-12 sm:py-16 md:py-20">
      <div class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8">
        <div class="case-study-content">
          <Content />
        </div>
      </div>
    </section>

    <!-- CTA -->
    <section class="border-strawhat-text/10 border-t py-16 sm:py-20 md:py-24">
      <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8">
        <div class="space-y-6 text-center">
          <h2
            class="text-strawhat-text text-xl font-light tracking-tight sm:text-2xl md:text-3xl"
          >
            Interested in working together?
          </h2>
          <a
            href="/#get-started"
            class="border-strawhat-yellow text-strawhat-yellow hover:border-strawhat-amber hover:text-strawhat-amber inline-block border-b-2 pb-1 text-base font-light tracking-wider transition-all sm:text-lg"
          >
            Start a project
          </a>
        </div>
      </div>
    </section>
  </article>
</Layout>

<style is:global>
  /* Case study content styling - minimal, on-theme */
  .case-study-content h2 {
    color: var(--strawhat-text);
    font-size: 1.5rem;
    font-weight: 300;
    letter-spacing: -0.025em;
    margin-top: 3rem;
    margin-bottom: 1.25rem;
  }

  .case-study-content h2:first-child {
    margin-top: 0;
  }

  .case-study-content h3 {
    color: var(--strawhat-text);
    font-size: 1.125rem;
    font-weight: 400;
    letter-spacing: -0.025em;
    margin-top: 2.5rem;
    margin-bottom: 1.25rem;
  }

  .case-study-content p {
    color: var(--strawhat-text-light);
    font-size: 1rem;
    font-weight: 300;
    line-height: 1.8;
    margin-bottom: 1.5rem;
  }

  .case-study-content ul {
    color: var(--strawhat-text-light);
    font-weight: 300;
    list-style: none;
    padding-left: 0;
    margin-bottom: 2rem;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem 2rem;
  }

  .case-study-content li {
    position: relative;
    padding-left: 1rem;
    line-height: 1.6;
    font-size: 0.9375rem;
  }

  .case-study-content li::before {
    content: "";
    position: absolute;
    left: 0;
    top: 0.55em;
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: var(--strawhat-yellow);
  }

  /* Responsive: single column on mobile */
  @media (max-width: 640px) {
    .case-study-content ul {
      grid-template-columns: 1fr;
      gap: 0.625rem;
    }
  }

  .case-study-content strong {
    color: var(--strawhat-text);
    font-weight: 500;
  }

  .case-study-content a {
    color: var(--strawhat-yellow);
    text-decoration: none;
    border-bottom: 1px solid currentColor;
    transition: opacity 0.2s;
  }

  .case-study-content a:hover {
    opacity: 0.7;
  }

  /* Minimal video controls - only play button and progress bar */
  .slideshow-video {
    background: #000;
  }

  .slideshow-video::-webkit-media-controls-panel {
    background: linear-gradient(to top, rgba(0, 0, 0, 0.5) 0%, transparent 50%);
    padding: 0 8px 6px;
  }

  /* Hide unwanted controls */
  .slideshow-video::-webkit-media-controls-mute-button,
  .slideshow-video::-webkit-media-controls-volume-slider,
  .slideshow-video::-webkit-media-controls-fullscreen-button,
  .slideshow-video::-webkit-media-controls-current-time-display,
  .slideshow-video::-webkit-media-controls-time-remaining-display,
  .slideshow-video::-webkit-media-controls-toggle-closed-captions-button,
  .slideshow-video::-webkit-media-controls-picture-in-picture-button,
  .slideshow-video::-webkit-media-controls-overflow-button {
    display: none !important;
  }

  /* Style play button */
  .slideshow-video::-webkit-media-controls-play-button {
    opacity: 0.9;
    transform: scale(0.9);
  }

  /* Style progress bar */
  .slideshow-video::-webkit-media-controls-timeline {
    height: 3px;
    border-radius: 3px;
    margin: 0 8px;
  }
</style>
